/*
 * display7seg.c
 *
 *  Created on: Oct 29, 2025
 *      Author: nguyen
 */

#include "display7SEG.h"

uint8_t table[10] = {
    0b1000000, // 0
    0b1111001, // 1
    0b0100100, // 2
    0b0110000, // 3
    0b0011001, // 4
    0b0010010, // 5
    0b0000010, // 6
    0b1111000, // 7
    0b0000000, // 8
    0b0010000 // 9
};


//SEG for landscape LED
void display7seg_landscape(int num){
	uint8_t n= table[num];
	GPIOB->ODR = (GPIOB->ODR & ~0x7F) | (n & 0x7F);
}

//A0 -> F0 for portrait LED
void display7seg_portrait(int num){
	uint8_t n= table[num];
	GPIOB->ODR = (GPIOB->ODR & ~(0x7F << 7)) | ((n & 0x7F) << 7);
}

const int MAX_LED = 4;
int index_ledlc = 0;
int index_ledpt = 2;
int led_buffer[4] = {1, 2, 3, 4};

//led_buffer is used 0 - 1 for landscape, 2 - 3 for portrait LED
void update7SEGLandscape(int index){
	display7seg_landscape(led_buffer[index]);
	switch(index){
		case 0:
			index_ledlc = 1;
			HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, RESET);
			HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, SET);
			break;
		case 1:
			index_ledlc = 0;
			HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, SET);
			HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, RESET);
			break;
		default:
			break;
	}
}

void update7SEGPortrait(int index){
	display7seg_portrait(led_buffer[index]);
	switch(index){
		case 2:
			index_ledpt = 3;
			HAL_GPIO_WritePin(EN2_GPIO_Port, EN2_Pin, RESET);
			HAL_GPIO_WritePin(EN3_GPIO_Port, EN3_Pin, SET);
			break;
		case 3:
			index_ledpt = 2;
			HAL_GPIO_WritePin(EN2_GPIO_Port, EN2_Pin, SET);
			HAL_GPIO_WritePin(EN3_GPIO_Port, EN3_Pin, RESET);
			break;
		default:
			break;
	}
}

int counter1 = 1, counter2 = 1;
void updateLedBufferMode1(){
	// 2 7-SEG LED Landscape
	/* Turn on RED-Landscape (count down from RED -> 0) */
	if (counter1 <= RED){
		led_buffer[0] = (RED - counter1 + 1) / 10;
		led_buffer[1] = (RED - counter1 + 1) % 10;
	}
	/* Turn on GREEN-Landscape (count down from GREEN -> 0) */
	else if (counter1 <= (RED + GREEN)){
		led_buffer[0] = (RED + GREEN - counter1 + 1) / 10;
		led_buffer[1] = (RED + GREEN - counter1 + 1) % 10;
	}
	/* Turn on AMPER-Landscape (count down from AMPER -> 0) */
	else{
		led_buffer[0] = (RED + GREEN + AMBER - counter1 + 1) / 10;
		led_buffer[1] = (RED + GREEN + AMBER - counter1 + 1) % 10;
	}
	counter1++;
	/* Return to turn on RED-Landscape */
	if (counter1 > RED + AMBER + GREEN) counter1 = 1;


	// 2 7-SEG LED Portrait
	/* Turn on GREEN-Portrait (count down from GREEN -> 0) */
	if (counter2 <= GREEN){
		led_buffer[2] = (GREEN - counter2 + 1) / 10;
		led_buffer[3] = (GREEN - counter2 + 1) % 10;
	}
	/* Turn on AMPER-Portrait (count down from AMPER -> 0) */
	else if (counter2 <= (AMBER + GREEN)){
		led_buffer[2] = (AMBER + GREEN - counter2 + 1) / 10;
		led_buffer[3] = (AMBER + GREEN - counter2 + 1) % 10;
	}
	/* Turn on RED-Portrait (count down from RED -> 0) */
	else {
		led_buffer[2] = (RED + GREEN + AMBER - counter2 + 1) / 10;
		led_buffer[3] = (RED + GREEN + AMBER - counter2 + 1) % 10;
	}
	counter2++;
	/* Return to turn on GREEN-Portrait */
	if (counter2 > RED + AMBER + GREEN) counter2 = 1;
}

void updateLedBufferMode2(){
	// Display mode 2
	led_buffer[0] = 0;
	led_buffer[1] = 2;
	// Display value RED
	led_buffer[2] = RED / 10;
	led_buffer[3] = RED % 10;
}

void updateLedBufferMode3(){
	// Display mode 3
	led_buffer[0] = 0;
	led_buffer[1] = 3;
	// Display value AMBER
	led_buffer[2] = AMBER / 10;
	led_buffer[3] = AMBER % 10;
}

void updateLedBufferMode4(){
	// Display mode 4
	led_buffer[0] = 0;
	led_buffer[1] = 4;
	// Display value GREEN
	led_buffer[2] = GREEN / 10;
	led_buffer[3] = GREEN % 10;
}



